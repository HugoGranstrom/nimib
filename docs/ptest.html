<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>ptest.nim</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>üê≥</text></svg>">
  <meta content="text/html; charset=utf-8" http-equiv="content-type">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <link rel='stylesheet' href='https://unpkg.com/normalize.css/'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/light.min.css">
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/pietroppeter/nimib/assets/atom-one-light.css'>
  </head>
<body>
<main>
<h1>Print-testing for nimib</h1>
<p>What is print-testing? Testing by comparing printed output of a file with a versioned reference (see <a href="https://github.com/treeform/ptest">treeform/ptest</a>).</p>
<h2>Test Results ‚úÖ</h2>
<table>
<thead>
<tr>
<th><span style="color:blue">skip</span></th>
<th><span style="color:red">fail</span></th>
<th><span style="color:green">pass</span></th>
<th>total</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>8</td>
<td>8</td>
</tr></tbody></table>
<pre><samp><span style="color:green">[OK]</span>   <a href="cheatsheet.html">cheatsheet.nim</a>
<span style="color:green">[OK]</span>   <a href="hello.html">hello.nim</a>
<span style="color:green">[OK]</span>   <a href="index.html">index.nim</a>
<span style="color:green">[OK]</span>   <a href="mostaccio.html">mostaccio.nim</a>
<span style="color:green">[OK]</span>   <a href="nolan.html">nolan.nim</a>
<span style="color:green">[OK]</span>   <a href="numerical.html">numerical.nim</a>
<span style="color:green">[OK]</span>   <a href="penguins.html">penguins.nim</a>
<span style="color:green">[OK]</span>   <a href="pythno.html">pythno.nim</a></samp></pre>
<hr />
<h1>Implementation</h1>
<p>The following is an adaption of <a href="https://github.com/treeform/ptest/blob/master/src/ptest.nim">treeform's ptest.nim</a>
taking into account specifics of nimib files: they already produce an output (html file).</p>
<p>Imports and global variables:</p>
<pre><code class="nim hljs"><span class="hljs-keyword">var</span>
  test: <span class="hljs-type">TestCase</span>
  tests: <span class="hljs-built_in">seq</span>[<span class="hljs-type">TestCase</span>]</code></pre>
<h3>test cases</h3>
<p>for every file ending in nim (and not starting with ptest) in nbProjDir (test cases)</p>
<ul>
<li>a test case will be skipped if it is not tracked in git</li>
<li>a test case will be skipped if it does not have a corresponding html</li>
<li>a test case will be skipped if it is modified/added in git</li>
</ul>
<pre><code class="nim hljs"><span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> walkDirRec(nbProjDir):
  <span class="hljs-comment">## note that file is an AbsoluteFile (since nbProjDir is an AbsoluteDir)</span>
  <span class="hljs-keyword">if</span> file.endsWith(<span class="hljs-string">&quot;.nim&quot;</span>) <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> file.name.startsWith(<span class="hljs-string">&quot;ptest&quot;</span>):
    test = <span class="hljs-type">TestCase</span>(file: file)
    <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;added test candidate: &quot;</span>, file.relPath
  <span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">continue</span>
  <span class="hljs-keyword">let</span> html = changeFileExt(file, <span class="hljs-string">&quot;.html&quot;</span>)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file.isGitTracked:
    test.skip = <span class="hljs-literal">true</span>
    test.skipReason = srNotTrackedInGit
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; -&gt; skipped since it is not tracked in git&quot;</span>
  <span class="hljs-keyword">elif</span> <span class="hljs-keyword">not</span> html.fileExists <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> html.isGitTracked:
    test.skip = <span class="hljs-literal">true</span>
    test.skipReason = srNoHtmlFound
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; -&gt; skipped since it does not have a corresponding (git tracked) html file&quot;</span>
  <span class="hljs-keyword">elif</span> file.isGitChanged:
    test.skip = <span class="hljs-literal">true</span>
    test.skipReason = srChangedInGit
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; -&gt; skipped since it is changed in git&quot;</span>
  <span class="hljs-keyword">else</span>:
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&quot;</span>
  tests.add test</code></pre>
<pre><samp>added test candidate: cheatsheet.nim
added test candidate: hello.nim
added test candidate: index.nim
added test candidate: mostaccio.nim
added test candidate: nolan.nim
added test candidate: numerical.nim
added test candidate: penguins.nim
added test candidate: pythno.nim</samp></pre>
<h3>performing test</h3>
<p>for every non-skipped test case:</p>
<ul>
<li>if the corresponding html output is changed in git the test is failed</li>
<li>copy the corresponding html to a tmp file</li>
<li>find and execute the corresponding nim file</li>
<li>if an error is found while compiling/executing, report a failure</li>
<li>if a difference is reported between the corresponding html file and the temporary copy a failure is reported</li>
<li>if no failure has been reported the test is reported as passed (and the temporary file is cleaned up)</li>
</ul>
<pre><code class="nim hljs"><span class="hljs-keyword">for</span> test <span class="hljs-keyword">in</span> tests:
  <span class="hljs-keyword">var</span>
    output: <span class="hljs-built_in">string</span>
    err: <span class="hljs-built_in">int</span>
  <span class="hljs-keyword">let</span>
    html = test.file.changeFileExt(<span class="hljs-string">&quot;.html&quot;</span>)
    tmp = test.file.changeFileExt(<span class="hljs-string">&quot;.tmp.html&quot;</span>)
    fileWithLink = test.file.relPath.aLink html.relPath
  <span class="hljs-keyword">if</span> test.skip:
    <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;[SKIP]&quot;</span>.spanColor <span class="hljs-string">&quot;blue&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; &quot;</span> &amp; fileWithLink
    <span class="hljs-keyword">continue</span>
  <span class="hljs-keyword">if</span> html.isGitChanged:
    test.fail = <span class="hljs-literal">true</span>
    <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;[FAIL]&quot;</span>.spanColor <span class="hljs-string">&quot;red&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; &quot;</span> &amp; fileWithLink
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;html file is changed in git. commit or revert and rerun test&quot;</span>
    <span class="hljs-keyword">continue</span>
  copyFile(source = html, dest = tmp)
  (output, err) = execCmdEx &amp;<span class="hljs-string">&quot;nim --verbosity:0 --hints:off r {test.file}&quot;</span>
  <span class="hljs-keyword">if</span> err != <span class="hljs-number">0</span>:
    test.fail = <span class="hljs-literal">true</span>
    <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;[FAIL]&quot;</span>.spanColor <span class="hljs-string">&quot;red&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; &quot;</span> &amp; fileWithLink
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Error during compile/run&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;output</span><span class="hljs-meta">\n</span><span class="hljs-string">:&quot;</span>, output
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;err</span><span class="hljs-meta">\n</span><span class="hljs-string">:&quot;</span>, err
    <span class="hljs-keyword">continue</span>
  (output, err) = execCmdEx(&amp;<span class="hljs-string">&quot;git diff --no-index {html} {tmp}&quot;</span>)
  <span class="hljs-keyword">if</span> err != <span class="hljs-number">0</span>:
    test.fail = <span class="hljs-literal">true</span>
    <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;[FAIL]&quot;</span>.spanColor <span class="hljs-string">&quot;red&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot; &quot;</span> &amp; fileWithLink
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Differences found in html file&quot;</span>
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;output</span><span class="hljs-meta">\n</span><span class="hljs-string">:&quot;</span>, output
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;err</span><span class="hljs-meta">\n</span><span class="hljs-string">:&quot;</span>, err
    <span class="hljs-keyword">continue</span>
  <span class="hljs-literal">stdout</span>.write <span class="hljs-string">&quot;[OK]&quot;</span>.spanColor <span class="hljs-string">&quot;green&quot;</span>
  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;   &quot;</span> &amp; fileWithLink
  removeFile(tmp)</code></pre>
<pre><samp><span style="color:green">[OK]</span>   <a href="cheatsheet.html">cheatsheet.nim</a>
<span style="color:green">[OK]</span>   <a href="hello.html">hello.nim</a>
<span style="color:green">[OK]</span>   <a href="index.html">index.nim</a>
<span style="color:green">[OK]</span>   <a href="mostaccio.html">mostaccio.nim</a>
<span style="color:green">[OK]</span>   <a href="nolan.html">nolan.nim</a>
<span style="color:green">[OK]</span>   <a href="numerical.html">numerical.nim</a>
<span style="color:green">[OK]</span>   <a href="penguins.html">penguins.nim</a>
<span style="color:green">[OK]</span>   <a href="pythno.html">pythno.nim</a></samp></pre>
<p>results are appended to previously save resultsBlock</p>
<pre><code class="nim hljs"><span class="hljs-keyword">let</span> (skip, fail, pass) = tests.stats
<span class="hljs-keyword">if</span> fail &gt; <span class="hljs-number">0</span>:
  resultsBlock.output.add <span class="hljs-string">&quot; ‚ùå&quot;</span>
<span class="hljs-keyword">else</span>:
  resultsBlock.output.add <span class="hljs-string">&quot; ‚úÖ&quot;</span>
<span class="hljs-keyword">let</span>
  skipHeader = <span class="hljs-string">&quot;skip&quot;</span>.spanColor <span class="hljs-string">&quot;blue&quot;</span>
  failHeader = <span class="hljs-string">&quot;fail&quot;</span>.spanColor <span class="hljs-string">&quot;red&quot;</span>
  passHeader = <span class="hljs-string">&quot;pass&quot;</span>.spanColor <span class="hljs-string">&quot;green&quot;</span>
resultsBlock.output.add &amp;<span class="hljs-string">&quot;</span><span class="hljs-meta">\n</span><span class="hljs-string">|{skipHeader}|{failHeader}|{passHeader}|total|&quot;</span>
resultsBlock.output.add &amp;<span class="hljs-string">&quot;</span><span class="hljs-meta">\n</span><span class="hljs-string">|---|---|---|---|&quot;</span>
resultsBlock.output.add &amp;<span class="hljs-string">&quot;</span><span class="hljs-meta">\n</span><span class="hljs-string">|{skip}|{fail}|{pass}|{skip + fail + pass}|&quot;</span>
resultsBlock.output.add &amp;<span class="hljs-string">&quot;</span><span class="hljs-meta">\n</span><span class="hljs-meta">\n</span><span class="hljs-string">{details.renderHtmlCodeOutput}&quot;</span></code></pre>

</main>
</body>
</html>